# Implementation Plan: d365-agent-mcpserver-dotnet

This document outlines the phased implementation plan for the `d365-agent-mcpserver-dotnet` repository. This service acts as the D365 MCP (Model Context Protocol) Server, exposing Dynamics 365 functionalities as tools for consumption by the `d365-agent-orchestrator`.

## Overall Goal
To build a robust, scalable, and maintainable .NET Core service that:
*   Implements the MCP server specification.
*   Securely connects to Dynamics 365 using a generated C# OData client (`d365-agent-odataclient-dotnet`).
*   Exposes a comprehensive set of D365 operations as MCP tools for Purchase, Sales, and other relevant business processes.
*   Handles D365 authentication, multi-instance requests, and error reporting.
*   Is containerized for deployment on Azure Container Apps or AKS.

---

## Phase 1: Core Setup & Basic Read-Only Tools

*   **Objectives:**
    *   Establish the .NET Core project structure for the MCP server.
    *   Integrate the C# MCP SDK (from `submodules/csharp-sdk` or its NuGet package).
    *   Integrate the generated D365 OData client from `d365-agent-odataclient-dotnet`.
    *   Implement basic MCP handshake and D365 authentication.
    *   Expose 1-2 simple read-only D365 MCP tools.
    *   Containerize and set up CI/CD.
*   **Tasks:**
    1.  **Project Initialization:**
        *   Create a new ASP.NET Core Web API project (or a suitable .NET Core worker/console project if using a different hosting model for the MCP server, though ASP.NET Core is common for MCP over HTTP).
        *   Set up project structure, dependencies.
    2.  **MCP SDK Integration:**
        *   Add reference to the C# MCP Server SDK.
        *   Implement MCP `initialize` handshake handler.
    3.  **D365 OData Client Integration:**
        *   Add NuGet package reference to the client generated by `d365-agent-odataclient-dotnet`.
    4.  **D365 Authentication:**
        *   Implement logic to authenticate with Dynamics 365 using Client Credentials flow (MSAL.NET).
        *   Securely retrieve D365 URL, Client ID, Client Secret, Tenant ID from Azure Key Vault.
        *   Implement a service/helper to create an authenticated `DataServiceContext` for D365 OData calls.
    5.  **Implement Basic Read-Only Tools:**
        *   Define and implement 1-2 simple D365 MCP tools (e.g., `getEnvironmentDetails`, `getCustomerByName`).
        *   These tools will use the generated .NET OData client to query D365.
    6.  **Error Handling:**
        *   Implement basic error handling within tools, returning structured `McpResponse` errors.
    7.  **Containerization:**
        *   Create a Dockerfile for the `d365-agent-mcpserver-dotnet` application.
    8.  **CI/CD Pipeline:**
        *   Set up a CI/CD pipeline (e.g., GitHub Actions) to build the Docker image, publish it to Azure Container Registry, and deploy to Azure Container Apps.
*   **Testing:**
    *   Unit tests for MCP tool implementations (mocking the D365 OData client context).
    *   Integration tests to verify D365 connection, authentication, and execution of the basic read-only tools against a D365 sandbox environment.
    *   Test MCP `initialize` and `discoverTools` calls from a test MCP client.

---

## Phase 2: Tools for Initial Purchase & Sales Scenarios

*   **Objectives:**
    *   Develop and expose D365 MCP tools required by the initial Purchase Order Ingestion and Sales (e.g., Quote/Order Inquiry) LangGraph agents in `d365-agent-orchestrator`.
*   **Tasks:**
    1.  **Identify Required D365 Tools:**
        *   Based on the PO Processing state machine (Receive, Extract, Validate D365, Create XML, Post to FTP/Blob) and initial Sales agent processes.
    2.  **Implement Purchase Process Tools:**
        *   Example tools: `simulateInvoicePostToD365` (for validation), `getVendorDetails`, `getParentMaterialInfo`, `checkStockAvailability`, `getContractualPricing`.
    3.  **Implement Sales Process Tools:**
        *   Example tools: `createQuote`, `getCustomerDetails`, `getProductPrice`, `Get_Customer_Remaining_Credit`.
    4.  **Tool Logic:**
        *   Ensure tools correctly use the .NET OData client for D365 operations.
        *   Implement necessary data transformations and business logic within each tool.
        *   Handle input parameters and structure output content as per MCP specifications.
    5.  **Error Handling & Validation:**
        *   Implement robust validation for tool input parameters.
        *   Enhance error handling to provide clear error messages in `McpResponse`.
*   **Testing:**
    *   Unit tests for all new D365 MCP tools, mocking D365 interactions.
    *   Integration tests for each tool against a D365 sandbox.
    *   E2E testing by calling these tools from the `d365-agent-orchestrator` (LangGraph agents) via `d365-agent-mcpclient-ts`.

---

## Phase 3: Tools for Expanded Processes & Multi-Instance Support

*   **Objectives:**
    *   Enable the D365 MCP Server to connect to multiple D365 instances/legal entities.
    *   Implement D365 MCP tools for expanded Purchase (Purchase Confirmation) and Sales (Sales Order Creation/Management) processes.
*   **Tasks:**
    1.  **Multi-Instance D365 Support:**
        *   Modify D365 authentication logic and `DataServiceContext` creation to accept a `companyId` or instance identifier as a parameter (passed through from the MCP tool request by the `d365-agent-mcpclient-ts`).
        *   Retrieve and use instance-specific D365 URLs/credentials from Azure Key Vault.
        *   Ensure OData calls are correctly scoped to the target D365 company/instance.
    2.  **Implement Purchase Confirmation Tools:**
        *   Example tools: `getPurchaseOrderStatus`, `confirmReceiptOfGoodsInD365`.
    3.  **Implement Sales Order Creation/Management Tools:**
        *   Example tools: `convertQuoteToSalesOrderInD365`, `updateD365OrderStatus`, `getD365InventoryLevels`.
*   **Testing:**
    *   Unit and integration tests for multi-instance tool execution.
    *   Unit and integration tests for all new D365 MCP tools related to expanded processes.
    *   E2E tests from `d365-agent-orchestrator` targeting different D365 instances.

---

## Phase 4: Optimization & Advanced Tooling

*   **Objectives:**
    *   Optimize performance of D365 MCP tools.
    *   Develop any advanced D365 MCP tools needed for self-learning or proactive scenarios driven by the `d365-agent-orchestrator`.
*   **Tasks:**
    1.  **Performance Optimization:**
        *   Implement caching strategies (e.g., using Azure Cache for Redis) for frequently accessed, semi-static D365 data (e.g., configuration data, product catalogs if appropriate).
        *   Analyze and optimize performance of long-running or frequently called D365 MCP tools (e.g., optimizing OData queries, reducing data payload sizes).
    2.  **Advanced Tool Development:**
        *   Based on requirements from the self-learning loop or proactive scenarios in `d365-agent-orchestrator`, implement any new, complex D365 MCP tools (e.g., tools for batch data analysis, complex data aggregation, or triggering specific D365 batch jobs).
    3.  **Monitoring and Logging:**
        *   Enhance logging within tools for better traceability and diagnostics.
        *   Ensure key performance indicators (KPIs) for tool execution are exposed to Application Insights.
*   **Testing:**
    *   Performance and load testing of critical D365 MCP tools.
    *   Validation of caching mechanisms.
    *   Tests for any new advanced tools.

This plan ensures that the `d365-agent-mcpserver-dotnet` evolves to provide a robust and comprehensive set of D365 tools for the AI agent system.
